#include "RML1028B.h"

_RML1028B RML1028B = {
	.COM0 = {GPIOA, PIN8},
	.COM1 = {GPIOA, PIN9},
	.COM2 = {GPIOA, PIN10},
	.COM3 = {GPIOB, PIN9},
	.SEG0 = {GPIOB, PIN10},
	.SEG1 = {GPIOB, PIN11},
	.SEG2 = {GPIOB, PIN12},
	.SEG3 = {GPIOB, PIN13},
	.SEG4 = {GPIOB, PIN14},
	.SEG5 = {GPIOB, PIN15},
	.SEG6 = {GPIOC, PIN6},
	.SEG7 = {GPIOC, PIN3},
	.SEG8 = {GPIOC, PIN2},
	.SEG9 = {GPIOC, PIN1},
	.SEG10 = {GPIOC, PIN0},
	.SEG11 = {GPIOB, PIN8},
	.SEG12 = {GPIOB, PIN5},
	.SEG13 = {GPIOB, PIN4},
	.SEG14 = {GPIOB, PIN3},
	.SEG15 = {GPIOD, PIN2},
	.SEG16 = {GPIOC, PIN12},
	.SEG17 = {GPIOC, PIN11},
	.BKLIGHT = {GPIOA, PIN15},
};

void RML1028B_Init(void)
{
	RML1028BIOCLKEN;                                        //使能IO时钟
	PWR->CR |= 1 << 8;
	RCC->CSR |= 0x01;                                        //打开LSI
	while (!(RCC->CSR & 0x02))
	{}                                //等待LSI启动
	RCC->CSR |= (1 << 23);                                    //RTC复位
	RCC->CSR &= ~(1 << 23);                                    //停止RTC复位
	RCC->CSR |= (1 << 22);                                    //使能RTC时钟
	RCC->CSR |= (0x02 << 16);                                //选择LSI作为RTC时钟
	RCC->APB1ENR |= (1 << 9);                                    //使能LCD时钟

	IoInit(RML1028B.COM0.PORT, RML1028B.COM0.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.COM1.PORT, RML1028B.COM1.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.COM2.PORT, RML1028B.COM2.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.COM3.PORT, RML1028B.COM3.PIN, IOFUNC, IOPU);

	IoInit(RML1028B.SEG0.PORT, RML1028B.SEG0.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.SEG1.PORT, RML1028B.SEG1.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.SEG2.PORT, RML1028B.SEG2.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.SEG3.PORT, RML1028B.SEG3.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.SEG4.PORT, RML1028B.SEG4.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.SEG5.PORT, RML1028B.SEG5.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.SEG6.PORT, RML1028B.SEG6.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.SEG7.PORT, RML1028B.SEG7.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.SEG8.PORT, RML1028B.SEG8.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.SEG9.PORT, RML1028B.SEG9.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.SEG10.PORT, RML1028B.SEG10.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.SEG11.PORT, RML1028B.SEG11.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.SEG12.PORT, RML1028B.SEG12.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.SEG13.PORT, RML1028B.SEG13.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.SEG14.PORT, RML1028B.SEG14.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.SEG15.PORT, RML1028B.SEG15.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.SEG16.PORT, RML1028B.SEG16.PIN, IOFUNC, IOPU);
	IoInit(RML1028B.SEG17.PORT, RML1028B.SEG17.PIN, IOFUNC, IOPU);

	//COM、SEG引脚配置为LCD功能
	GPIO_AF_Set(RML1028B.COM0.PORT, Pin2Num(RML1028B.COM0.PIN), 11);
	GPIO_AF_Set(RML1028B.COM1.PORT, Pin2Num(RML1028B.COM1.PIN), 11);
	GPIO_AF_Set(RML1028B.COM2.PORT, Pin2Num(RML1028B.COM2.PIN), 11);
	GPIO_AF_Set(RML1028B.COM3.PORT, Pin2Num(RML1028B.COM3.PIN), 11);
	GPIO_AF_Set(RML1028B.SEG0.PORT, Pin2Num(RML1028B.SEG0.PIN), 11);
	GPIO_AF_Set(RML1028B.SEG1.PORT, Pin2Num(RML1028B.SEG1.PIN), 11);
	GPIO_AF_Set(RML1028B.SEG2.PORT, Pin2Num(RML1028B.SEG2.PIN), 11);
	GPIO_AF_Set(RML1028B.SEG3.PORT, Pin2Num(RML1028B.SEG3.PIN), 11);
	GPIO_AF_Set(RML1028B.SEG4.PORT, Pin2Num(RML1028B.SEG4.PIN), 11);
	GPIO_AF_Set(RML1028B.SEG5.PORT, Pin2Num(RML1028B.SEG5.PIN), 11);
	GPIO_AF_Set(RML1028B.SEG6.PORT, Pin2Num(RML1028B.SEG6.PIN), 11);
	GPIO_AF_Set(RML1028B.SEG7.PORT, Pin2Num(RML1028B.SEG7.PIN), 11);
	GPIO_AF_Set(RML1028B.SEG8.PORT, Pin2Num(RML1028B.SEG8.PIN), 11);
	GPIO_AF_Set(RML1028B.SEG9.PORT, Pin2Num(RML1028B.SEG9.PIN), 11);
	GPIO_AF_Set(RML1028B.SEG10.PORT, Pin2Num(RML1028B.SEG10.PIN), 11);
	GPIO_AF_Set(RML1028B.SEG11.PORT, Pin2Num(RML1028B.SEG11.PIN), 11);
	GPIO_AF_Set(RML1028B.SEG12.PORT, Pin2Num(RML1028B.SEG12.PIN), 11);
	GPIO_AF_Set(RML1028B.SEG13.PORT, Pin2Num(RML1028B.SEG13.PIN), 11);
	GPIO_AF_Set(RML1028B.SEG14.PORT, Pin2Num(RML1028B.SEG14.PIN), 11);
	GPIO_AF_Set(RML1028B.SEG15.PORT, Pin2Num(RML1028B.SEG15.PIN), 11);
	GPIO_AF_Set(RML1028B.SEG16.PORT, Pin2Num(RML1028B.SEG16.PIN), 11);
	GPIO_AF_Set(RML1028B.SEG17.PORT, Pin2Num(RML1028B.SEG17.PIN), 11);

	LCD->FCR |= (0x02 << 22);
	LCD->FCR |= (0x06 << 18);
	LCD->FCR |= (0x02 << 16);
	LCD->FCR |= (0x01 << 13);
	LCD->FCR |= (0x01 << 4);
	LCD->FCR |= 0x01;
	LCD->CR |= 0xCF;                                        //bias 1/3 duty 1/4 外部电源供电 使能LCD控制器

	IoInit(RML1028B.BKLIGHT.PORT, RML1028B.BKLIGHT.PIN, IOOUT, IOPU);
	BKLIGHTON;                                                //默认打开背光
}

